<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flzyy.xyz AI Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Custom scrollbar for webkit browsers */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #27272a; /* zinc-800 */
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #52525b; /* zinc-600 */
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #71717a; /* zinc-500 */
      }

      /* Base font */
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }

      /* Spinner animation for typing indicator */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        animation: spin 1s linear infinite;
      }

      /* Spinner animation for send button */
      @keyframes button-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .button-spinner {
        animation: button-spin 0.5s linear infinite;
      }

      /* Add prose styles for formatting AI responses (like code blocks, lists) */
      .prose {
        max-width: 100% !important;
      }
      .prose :where(code):not(:where([class~="not-prose"] *))::before {
        content: "" !important;
      }
      .prose :where(code):not(:where([class~="not-prose"] *))::after {
        content: "" !important;
      }
    </style>
  </head>
  <body class="h-full bg-gray-900 text-gray-100 antialiased">
    <div
      class="flex h-full max-h-full flex-col max-w-3xl mx-auto px-4 pt-6 pb-4"
    >
      <!-- Header -->
      <header class="text-center mb-4">
        <h1
          class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500"
        >
          Flzyy.xyz AI Chat
        </h1>
        <p class="text-gray-400 text-sm mt-1">
          Powered by Cloudflare Workers AI
        </p>
      </header>

      <!-- Chat Container -->
      <div
        class="flex flex-col flex-1 bg-gray-800 border border-gray-700 rounded-lg shadow-xl overflow-hidden min-h-0"
      >
        <!-- Chat Messages -->
        <div
          id="chat-messages"
          class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 custom-scrollbar"
        >
          <!-- Welcome Message -->
          <div class="flex">
            <div
              class="message assistant-message bg-gray-700 text-gray-200 mr-auto p-4 rounded-lg max-w-xs md:max-w-md"
            >
              <p
                class="prose prose-invert prose-sm text-gray-200 break-words"
              >
                Hello! I'm an LLM chat app powered by Cloudflare Workers AI. How
                can I help you today?
              </p>
            </div>
          </div>
          <!-- Dynamic messages will be added here -->
        </div>

        <!-- Typing Indicator -->
        <div
          id="typing-indicator"
          class="hidden items-center justify-center p-4 border-t border-gray-700"
        >
          <div
            class="w-6 h-6 border-2 border-blue-400 border-t-transparent rounded-full spinner"
          ></div>
          <span class="ml-3 text-sm text-gray-400">AI is thinking...</span>
        </div>

        <!-- Message Input -->
        <div
          class="flex items-start p-3 md:p-4 border-t border-gray-700 bg-gray-800"
        >
          <textarea
            id="user-input"
            placeholder="Type your message here..."
            rows="1"
            class="flex-1 bg-gray-700 border border-gray-600 rounded-lg p-3 text-gray-100 placeholder-gray-400 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            style="min-height: 44px; max-height: 200px"
          ></textarea>
          <button
            id="send-button"
            class="ml-3 flex-shrink-0 w-11 h-11 flex items-center justify-center bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg transition-all duration-200 hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <!-- Send Icon -->
            <svg
              id="send-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-send-horizontal"
            >
              <path d="m3 3 3 9-3 9 19-9Z" />
              <path d="M6 12h16" />
            </svg>
            <!-- Button Spinner Icon -->
            <svg
              id="spinner-icon"
              class="w-5 h-5 button-spinner hidden"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-4 text-center">
        <p class="text-xs text-gray-500">
          Flzyy.xyz AI Chat &copy; 2025. AI can make mistakes.
        </p>
      </footer>
    </div>

    <!-- Chat Logic -->
    <script type="module">
      // --- DOM Elements ---
      const chatMessages = document.getElementById("chat-messages");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const typingIndicator = document.getElementById("typing-indicator");
      const sendIcon = document.getElementById("send-icon");
      const spinnerIcon = document.getElementById("spinner-icon");

      // --- UI Helper Functions ---

      function addMessageToDOM(sender, text) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex"; // Use flex to align messages

        const contentDiv = document.createElement("div");
        contentDiv.className =
          "p-4 rounded-lg max-w-xs md:max-w-lg break-words";

        // Style based on sender
        if (sender === "user") {
          contentDiv.classList.add("bg-blue-600", "text-white", "ml-auto");
        } else if (sender === "assistant") {
          contentDiv.classList.add("bg-gray-700", "text-gray-200", "mr-auto");
        } else {
          // For errors
          contentDiv.classList.add("bg-red-800", "text-red-100", "mr-auto");
        }

        // Use a <p> tag with prose for better formatting of AI responses
        const textParagraph = document.createElement("p");
        textParagraph.className =
          "prose prose-invert prose-sm text-inherit";
        
        // A simple way to format newlines
        // Use textContent first to sanitize, then innerHTML for line breaks
        textParagraph.textContent = text;
        textParagraph.innerHTML = textParagraph.innerHTML.replace(/\n/g, "<br>");

        contentDiv.appendChild(textParagraph);
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
      }

      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function setLoadingState(isLoading, isThinking) {
        if (isLoading) {
          sendButton.disabled = true;
          sendIcon.classList.add("hidden");
          spinnerIcon.classList.remove("hidden");
        } else {
          sendButton.disabled = false;
          sendIcon.classList.remove("hidden");
          spinnerIcon.classList.add("hidden");
        }

        if (isThinking) {
          typingIndicator.classList.remove("hidden");
          typingIndicator.classList.add("flex");
        } else {
          typingIndicator.classList.add("hidden");
          typingIndicator.classList.remove("flex");
        }
        scrollToBottom();
      }

      // Auto-resize textarea
      function autoResizeTextarea() {
        userInput.style.height = "auto"; // Reset height
        userInput.style.height = `${Math.min(
          userInput.scrollHeight,
          200
        )}px`; // Set to scrollHeight up to max
      }

      // --- Chat Logic ---

      async function handleSendMessage() {
        const messageText = userInput.value.trim();
        if (!messageText) {
          return; // Don't send empty messages
        }

        // 1. Add user message to DOM
        addMessageToDOM("user", messageText);
        scrollToBottom();

        // 2. Disable input and show loading state
        setLoadingState(true, true);
        userInput.value = "";
        autoResizeTextarea();

        try {
          // 3. Get AI response from your Cloudflare Worker
          const aiResponse = await getCloudflareAIResponse(messageText);

          // 4. Add AI response to DOM
          addMessageToDOM("assistant", aiResponse);

        } catch (error) {
          console.error("Error sending message:", error);
          addMessageToDOM("error", `Error: ${error.message}`);
        } finally {
          // 5. Re-enable input
          setLoadingState(false, false);
          scrollToBottom();
        }
      }

      /**
       * Fetches a response from your Cloudflare Worker AI.
       *
       * *******************************************************************
       * * TODO: Update the `workerUrl` with your Cloudflare Worker endpoint.
       * * You will also need to adjust the `fetch` `body` and
       * * response parsing (`data.response`) to match your
       * * specific Worker's API contract.
       * *******************************************************************
       */
      async function getCloudflareAIResponse(userMessage) {
        // !!! IMPORTANT: Replace this with your actual Worker URL !!!
        const workerUrl = "chat.js"; // e.g., "https://my-worker.my-domain.workers.dev"

        try {
          const response = await fetch(workerUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            // This body is an *example*. Adjust it to what your worker expects.
            body: JSON.stringify({
              message: userMessage,
              // You might also send history here if your worker supports it
              // history: []
            }),
          });

          if (!response.ok) {
            throw new Error(`Worker Error: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();

          // This assumes your worker returns JSON like: { "response": "Hello!" }
          // Adjust this to match your worker's actual response structure.
          if (data && data.response) {
            return data.response;
          } else {
            return "Sorry, I received an unknown response from the AI.";
          }

        } catch (error) {
          console.error("Error fetching from Cloudflare Worker:", error);
          return `Sorry, I couldn't connect to the AI. (${error.message})`;
        }
      }


      // --- Event Listeners ---
      sendButton.addEventListener("click", handleSendMessage);
      userInput.addEventListener("keydown", (e) => {
        // Send on Enter (not Shift+Enter)
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault(); //
          handleSendMessage();
        }
      });

      // Add listener for auto-resizing
      userInput.addEventListener("input", autoResizeTextarea);
      
      // Scroll to bottom on load
      window.addEventListener("DOMContentLoaded", () => {
        scrollToBottom();
      });

    </script>
  </body>
</html>
